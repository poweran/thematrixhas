<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workout Log</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111827;
      --card-2: #020617;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #38bdf8;
      --done: #22c55e;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #0f172a, var(--bg));
      color: var(--text);
      padding: 24px;
    }

    .container {
      max-width: 1200px;
      margin: auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 22px;
      margin: 0;
    }

    .subtitle {
      color: var(--muted);
      font-size: 13px;
    }

    .card {
      background: linear-gradient(180deg, #020617, #020617) padding-box,
        linear-gradient(180deg, #1f2937, #020617) border-box;
      border: 1px solid transparent;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, .45);
      padding: 16px;
      margin-bottom: 24px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
    }

    thead th {
      position: sticky;
      top: 0;
      background: var(--card);
      z-index: 2;
      color: var(--muted);
      font-weight: 500;
      padding: 10px 6px;
      border-bottom: 1px solid var(--border);
    }

    tbody td {
      padding: 8px 6px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    tbody tr:hover {
      background: rgba(56, 189, 248, .04);
    }

    td.group {
      text-align: left;
      font-weight: 600;
      padding-left: 12px;
      white-space: nowrap;
      cursor: pointer;
      color: var(--accent);
    }

    td.group:hover {
      text-decoration: underline;
    }

    .cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    input {
      width: 46px;
      height: 32px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      text-align: center;
      font-size: 13px;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
    }

    button.set {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: .15s;
      font-weight: 600;
    }

    button.set.done {
      background: var(--done);
      border-color: var(--done);
      color: #052e16;
    }

    button.set:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .controls button {
      padding: 10px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      font-weight: 500;
    }

    .controls button.primary {
      background: linear-gradient(180deg, #38bdf8, #0ea5e9);
      color: #002233;
      border: none;
    }

    #stats h2 {
      margin: 0 0 12px 0;
      font-size: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .stat {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }

    .stat .label {
      font-size: 12px;
      color: var(--muted);
    }

    .stat .value {
      font-size: 22px;
      font-weight: 600;
      margin-top: 4px;
    }

    /* Timer Styles */
    .timer-container {
      background: var(--card-2);
      margin-bottom: 20px;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid var(--border);
    }

    .timer-display {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
      min-width: 100px;
    }

    .timer-controls {
      display: flex;
      gap: 8px;
    }

    .timer-btn {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: .2s;
      font-weight: 500;
    }

    .timer-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .timer-btn.active {
      background: var(--accent);
      color: #0b1220;
      border-color: var(--accent);
    }

    #modalImg {
      background-color: #fff;
    }
  </style>
</head>

<body>
  <div class="container">

    <header>
      <div>
        <h1>Workout Log</h1>
        <div class="subtitle">2 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ¬∑ 4 –ø–æ–¥—Ö–æ–¥–∞ ¬∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π</div>
      </div>
    </header>

    <div class="card">
      <table id="log"></table>
    </div>

    <div id="stats" class="card"></div>

    <div class="controls" style="align-items: center; flex-wrap: wrap;">
      <button class="primary" onclick="saveData()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="resetData()">–°–±—Ä–æ—Å</button>
      <div style="display:flex; align-items:center; gap:8px;">
        <button onclick="toggleZapper()" id="zapperBtn"
          style="position:relative; height:40px; display:flex; align-items:center; gap:6px;">
          <span id="zapperIcon" style="opacity:0.5">‚ö°</span> Zapper
        </button>
        <canvas id="zapperScope" width="160" height="40"
          style="display:none; height:40px; background:#020617; border-radius:8px; border:1px solid var(--border);"></canvas>
      </div>
    </div>

  </div>

  <!-- Modal -->
  <div id="modal" onclick="if(event.target===this)closeModal()"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); z-index:1000; overflow-y:auto;">
    <div
      style="max-width:550px; margin:4% auto; background:var(--card); border-radius:18px; padding:24px; position:relative; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);">
      <button onclick="closeModal()"
        style="position:absolute; right:16px; top:16px; background:none; border:none; color:var(--muted); font-size:24px; cursor:pointer; padding:4px; line-height:1; z-index:10;">‚úï</button>
      <h2 id="modalTitle" style="margin-top:0; font-size:24px; margin-bottom:16px;"></h2>
      <img id="modalImg"
        style="width:100%; border-radius:12px; border:1px solid var(--border); margin-bottom:20px; aspect-ratio:16/9; object-fit:cover;" />

      <!-- Timer Interface -->
      <div class="timer-container">
        <div id="timerDisplay" class="timer-display">00:00</div>
        <div class="timer-controls">
          <button class="timer-btn" onclick="addTime(30)">+30s</button>
          <button class="timer-btn" onclick="toggleTimer()" id="timerToggleBtn">Start</button>
          <button class="timer-btn" onclick="resetTimer()">Reset</button>
        </div>
      </div>

      <div id="sideAlert"
        style="display:none; background:rgba(56, 189, 248, 0.1); border:1px solid var(--accent); color:var(--accent); padding:10px; border-radius:8px; margin-bottom:16px; font-weight:500; text-align:center;">
        ‚ö†Ô∏è –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –≤—Ç–æ—Ä—É—é —Å—Ç–æ—Ä–æ–Ω—É!
      </div>

      <div id="modalDesc" style="color:var(--text); line-height:1.6; font-size:15px;"></div>
    </div>
  </div>

  <script>
    const muscles = ['–ù–æ–≥–∏', '–ò–∫—Ä—ã', '–ì—Ä—É–¥—å', '–°–ø–∏–Ω–∞', '–ö–æ—Ä'];

    const muscleDescriptions = {
      '–ù–æ–≥–∏': `
        <h3 style="margin-top:0; color:var(--accent);">–ë–æ–ª–≥–∞—Ä—Å–∫–∏–µ —Å–ø–ª–∏—Ç-–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è</h3>
        <p>–≠—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ª—É—á—à–µ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≥ –±–µ–∑ –≤–µ—Å–∞. –ó–∞ —Å—á–µ—Ç —Ç–æ–≥–æ, —á—Ç–æ –æ–¥–Ω–∞ –Ω–æ–≥–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞ –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –≤–æ–∑–≤—ã—à–µ–Ω–∏–∏ (–¥–∏–≤–∞–Ω, —Å—Ç—É–ª), —Ä–∞–±–æ—á–∞—è –Ω–æ–≥–∞ –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–æ—Å—Å–∞–ª—å–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É –∏ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ.</p>
        <p><strong>–¢–µ—Ö–Ω–∏–∫–∞:</strong> –í—Å—Ç–∞–Ω—å—Ç–µ —Å–ø–∏–Ω–æ–π –∫ —Å—Ç—É–ª—É/–¥–∏–≤–∞–Ω—É, –ø–æ–ª–æ–∂–∏—Ç–µ –ø–æ–¥—ä–µ–º –∑–∞–¥–Ω–µ–π –Ω–æ–≥–∏ –Ω–∞ –æ–ø–æ—Ä—É. –°–¥–µ–ª–∞–π—Ç–µ —à–∞–≥ –≤–ø–µ—Ä–µ–¥ —Ä–∞–±–æ—á–µ–π –Ω–æ–≥–æ–π. –ú–µ–¥–ª–µ–Ω–Ω–æ –æ–ø—É—Å–∫–∞–π—Ç–µ—Å—å –≤–Ω–∏–∑, –ø–æ–∫–∞ –±–µ–¥—Ä–æ –ø–µ—Ä–µ–¥–Ω–µ–π –Ω–æ–≥–∏ –Ω–µ —Å—Ç–∞–Ω–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø–æ–ª—É. –ö–æ–ª–µ–Ω–æ –∑–∞–¥–Ω–µ–π –Ω–æ–≥–∏ –ø–æ—á—Ç–∏ –∫–∞—Å–∞–µ—Ç—Å—è –ø–æ–ª–∞. –î–µ—Ä–∂–∏—Ç–µ –∫–æ—Ä–ø—É—Å —Ä–æ–≤–Ω–æ –∏–ª–∏ —Å–ª–µ–≥–∫–∞ –Ω–∞–∫–ª–æ–Ω–∏—Ç–µ –≤–ø–µ—Ä–µ–¥ –¥–ª—è –±–æ–ª—å—à–µ–≥–æ –∞–∫—Ü–µ–Ω—Ç–∞ –Ω–∞ —è–≥–æ–¥–∏—Ü—É.</p>
        <p><strong>–ü–æ—á–µ–º—É —ç—Ç–æ —Ç–æ–ø:</strong> –†–∞–∑–≤–∏–≤–∞–µ—Ç —Å–∏–ª—É, –º–∞—Å—Å—É, –±–∞–ª–∞–Ω—Å –∏ –º–æ–±–∏–ª—å–Ω–æ—Å—Ç—å —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω–æ–≥–æ —Å—É—Å—Ç–∞–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.</p>
      `,
      '–ò–∫—Ä—ã': `
        <h3 style="margin-top:0; color:var(--accent);">–ü–æ–¥—ä–µ–º—ã –Ω–∞ –Ω–æ—Å–∫–∏ –Ω–∞ –≤–æ–∑–≤—ã—à–µ–Ω–Ω–æ—Å—Ç–∏ (Calf Raises on a Step)</h3>
        <p>–ì–ª–∞–≤–Ω—ã–π —Å–µ–∫—Ä–µ—Ç ‚Äî —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ –≤ –Ω–∏–∂–Ω–µ–π —Ç–æ—á–∫–µ. –ù–∞ –ø–æ–ª—É –µ–≥–æ –Ω–µ—Ç.</p>
        
        <p><strong>–ß—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è:</strong> –õ—é–±–∞—è —É—Å—Ç–æ–π—á–∏–≤–∞—è –≤–æ–∑–≤—ã—à–µ–Ω–Ω–æ—Å—Ç—å –≤—ã—Å–æ—Ç–æ–π —Ö–æ—Ç—è –±—ã 5-10 —Å–º. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å:</p>
        <ul>
            <li>–°—Ç—É–ø–µ–Ω—å–∫–∞ –ª–µ—Å—Ç–Ω–∏—Ü—ã.</li>
            <li>–ü—Ä–æ—á–Ω—ã–π –ø–æ—Ä–æ–≥.</li>
            <li>–¢–æ–ª—Å—Ç–∞—è –∫–Ω–∏–≥–∞ –∏–ª–∏ –±—Ä—É—Å–æ–∫ –¥–µ—Ä–µ–≤–∞ (—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∏ –Ω–µ —Å–∫–æ–ª—å–∑—è—Ç!).</li>
        </ul>

        <p><strong>–ò.–ü. (–ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ):</strong></p>
        <ul>
            <li>–í—Å—Ç–∞–Ω—å—Ç–µ —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–∞ –≤–æ–∑–≤—ã—à–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –ø–æ–¥—É—à–µ—á–∫–∏ —Å—Ç–æ–ø –∏ –ø–∞–ª—å—Ü—ã.</li>
            <li>–ü—è—Ç–∫–∏ –¥–æ–ª–∂–Ω—ã —Å–≤–∏—Å–∞—Ç—å –≤ –≤–æ–∑–¥—É—Ö–µ.</li>
            <li>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ—Å—å —Ä—É–∫–æ–π –∑–∞ —Å—Ç–µ–Ω—É, –¥–≤–µ—Ä–Ω–æ–π –∫–æ—Å—è–∫ –∏–ª–∏ —Å—Ç—É–ª –¥–ª—è —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è (–Ω–µ –ø–æ–º–æ–≥–∞–π—Ç–µ —Å–µ–±–µ —Ä—É–∫–æ–π –ø–æ–¥–Ω–∏–º–∞—Ç—å—Å—è, —Ç–æ–ª—å–∫–æ –±–∞–ª–∞–Ω—Å!).</li>
            <li>–ù–æ–≥–∏ –≤ –∫–æ–ª–µ–Ω—è—Ö –≤—ã–ø—Ä—è–º–ª–µ–Ω—ã (–Ω–æ –Ω–µ ¬´–∑–∞—â–µ–ª–∫–Ω—É—Ç—ã¬ª –≤ —Å—É—Å—Ç–∞–≤–µ –Ω–∞–º–µ—Ä—Ç–≤–æ, –ø—Ä–æ—Å—Ç–æ –ø—Ä—è–º—ã–µ).</li>
        </ul>

        <p><strong>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:</strong></p>
        <ul>
            <li><strong>–§–∞–∑–∞ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è (–í–Ω–∏–∑):</strong> –ú–µ–¥–ª–µ–Ω–Ω–æ –∏ –ø–æ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ (–Ω–∞ 2-3 —Å—á–µ—Ç–∞) –æ–ø—É—Å–∫–∞–π—Ç–µ –ø—è—Ç–∫–∏ –≤–Ω–∏–∑, –Ω–∏–∂–µ —É—Ä–æ–≤–Ω—è —Å—Ç—É–ø–µ–Ω—å–∫–∏, –Ω–∞—Å—Ç–æ–ª—å–∫–æ –≥–ª—É–±–æ–∫–æ, –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–æ–ª–µ–Ω–æ—Å—Ç–æ–ø. –í—ã –¥–æ–ª–∂–Ω—ã –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–∏–ª—å–Ω–æ–µ, –ø—Ä–∏—è—Ç–Ω–æ–µ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ –≤ –∑–∞–¥–Ω–µ–π —á–∞—Å—Ç–∏ –≥–æ–ª–µ–Ω–∏. –≠—Ç–æ —Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è!</li>
            <li><strong>–§–∞–∑–∞ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è (–í–≤–µ—Ä—Ö):</strong> –ú–æ—â–Ω—ã–º –¥–≤–∏–∂–µ–Ω–∏–µ–º (–Ω–∞ 1 —Å—á–µ—Ç) –ø–æ–¥–Ω–∏–º–∏—Ç–µ—Å—å –Ω–∞ –Ω–æ—Å–∫–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤—ã—Å–æ–∫–æ, –∫–∞–∫ –±–∞–ª–µ—Ä–∏–Ω–∞.</li>
            <li><strong>–ü–∏–∫ (–í–µ—Ä—Ö–Ω—è—è —Ç–æ—á–∫–∞):</strong> –í —Å–∞–º–æ–π –≤–µ—Ä—Ö–Ω–µ–π —Ç–æ—á–∫–µ –∑–∞–¥–µ—Ä–∂–∏—Ç–µ—Å—å –Ω–∞ 1-2 —Å–µ–∫—É–Ω–¥—ã –∏ –∏–∑–æ –≤—Å–µ—Ö —Å–∏–ª –Ω–∞–ø—Ä—è–≥–∏—Ç–µ –∏–∫—Ä—ã.</li>
        </ul>

        <p><strong>–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫?</strong> –ö–æ–≥–¥–∞ –≤—ã —Å—Ç–æ–∏—Ç–µ –Ω–∞ –ø–æ–ª—É, –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –≤ –ø–æ–ª–æ–≤–∏–Ω—É –∞–º–ø–ª–∏—Ç—É–¥—ã. –ö–æ–≥–¥–∞ –≤—ã –Ω–∞ —Å—Ç—É–ø–µ–Ω—å–∫–µ, –≤—ã —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç–µ –º—ã—à—Ü—É –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π –≤–∞—à–µ–≥–æ —Ç–µ–ª–∞ –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –µ–µ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å. –≠—Ç–æ –¥–∞–µ—Ç –≥–æ—Ä–∞–∑–¥–æ –±–æ–ª—å—à–∏–π —Å—Ç–∏–º—É–ª –¥–ª—è —Ä–æ—Å—Ç–∞.</p>

        <p><strong>–í–∞–∂–Ω—ã–π –Ω—é–∞–Ω—Å (–ø—Ä—è–º—ã–µ vs —Å–æ–≥–Ω—É—Ç—ã–µ –∫–æ–ª–µ–Ω–∏):</strong></p>
        <ul>
            <li><strong>–ï—Å–ª–∏ –∫–æ–ª–µ–Ω–∏ –ø—Ä—è–º—ã–µ:</strong> –ë–æ–ª—å—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∫—Ä–æ–Ω–æ–∂–Ω–∞—è –º—ã—à—Ü–∞ (—Ç–∞ —Å–∞–º–∞—è, –∫–æ—Ç–æ—Ä–∞—è –¥–∞–µ—Ç –æ–±—ä–µ–º –∏ —Ñ–æ—Ä–º—É "—Å–µ—Ä–¥–µ—á–∫–∞" —Å–≤–µ—Ä—Ö—É).</li>
            <li><strong>–ï—Å–ª–∏ –∫–æ–ª–µ–Ω–∏ —Å–ª–µ–≥–∫–∞ —Å–æ–≥–Ω—É—Ç—ã (–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Å–æ–≥–Ω—É—Ç—ã–º–∏ –≤—Å–µ –≤—Ä–µ–º—è):</strong> –ù–∞–≥—Ä—É–∑–∫–∞ —Å–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–º–±–∞–ª–æ–≤–∏–¥–Ω—É—é –º—ã—à—Ü—É (–æ–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–¥ –∏–∫—Ä–æ–Ω–æ–∂–Ω–æ–π –∏ –ø—Ä–∏–¥–∞–µ—Ç –≥–æ–ª–µ–Ω–∏ "—Ç–æ–ª—â–∏–Ω—É" —Å–Ω–∏–∑—É).</li>
        </ul>
      `,
      '–ì—Ä—É–¥—å': `
        <h3 style="margin-top:0; color:var(--accent);">–û—Ç–∂–∏–º–∞–Ω–∏—è —Å –Ω–æ–≥–∞–º–∏ –Ω–∞ –≤–æ–∑–≤—ã—à–µ–Ω–Ω–æ—Å—Ç–∏</h3>
        <p>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –æ—Ç–∂–∏–º–∞–Ω–∏—è –±—ã—Å—Ç—Ä–æ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å–ª–∏—à–∫–æ–º –ª–µ–≥–∫–∏–º–∏. –ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞—Å—Ç–∏—Ç—å –º—ã—à—Ü—ã –∏ —Å–∏–ª—É, –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É. –ü–æ–¥–Ω—è–≤ –Ω–æ–≥–∏ –≤—ã—à–µ –≥–æ–ª–æ–≤—ã, –º—ã —Å–º–µ—â–∞–µ–º —Ü–µ–Ω—Ç—Ä —Ç—è–∂–µ—Å—Ç–∏ –∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª—å—à–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤–µ—Å–∞ —Ç–µ–ª–∞ –Ω–∞ —Ä—É–∫–∏ –∏ –≥—Ä—É–¥—å, –æ—Å–æ–±–µ–Ω–Ω–æ –∞–∫—Ü–µ–Ω—Ç–∏—Ä—É—è –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –≤–µ—Ä—Ö–µ –≥—Ä—É–¥–Ω—ã—Ö –º—ã—à—Ü.</p>
        <p><strong>–¢–µ—Ö–Ω–∏–∫–∞:</strong> –ü—Ä–∏–º–∏—Ç–µ —É–ø–æ—Ä –ª–µ–∂–∞, –∑–∞—Ç–µ–º –ø–æ—Å—Ç–∞–≤—å—Ç–µ –Ω–æ—Å–∫–∏ –Ω–æ–≥ –Ω–∞ —É—Å—Ç–æ–π—á–∏–≤—ã–π —Å—Ç—É–ª, –¥–∏–≤–∞–Ω –∏–ª–∏ –∫—Ä–æ–≤–∞—Ç—å. –¢–µ–ª–æ –¥–æ–ª–∂–Ω–æ –æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ –ø—Ä—è–º—É—é –ª–∏–Ω–∏—é –æ—Ç –ø—è—Ç–æ–∫ –¥–æ –º–∞–∫—É—à–∫–∏ (–ø–ª–∞–Ω–∫–∞). –†—É–∫–∏ –Ω–∞ —à–∏—Ä–∏–Ω–µ –ø–ª–µ—á –∏–ª–∏ —á—É—Ç—å —à–∏—Ä–µ. –ú–µ–¥–ª–µ–Ω–Ω–æ –æ–ø—É—Å–∫–∞–π—Ç–µ—Å—å –≤–Ω–∏–∑, –ø–æ–∫–∞ –≥—Ä—É–¥—å –Ω–µ –æ–∫–∞–∂–µ—Ç—Å—è –≤ –ø–∞—Ä–µ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–æ–≤ –æ—Ç –ø–æ–ª–∞. –õ–æ–∫—Ç–∏ –¥–µ—Ä–∂–∏—Ç–µ –ø–æ–¥ —É–≥–ª–æ–º –ø—Ä–∏–º–µ—Ä–Ω–æ 45 –≥—Ä–∞–¥—É—Å–æ–≤ –∫ —Ç–µ–ª—É (–Ω–µ —Ä–∞–∑–≤–æ–¥–∏—Ç–µ –∏—Ö —à–∏—Ä–æ–∫–æ –≤ —Å—Ç–æ—Ä–æ–Ω—ã, —ç—Ç–æ –≤—Ä–µ–¥–Ω–æ –¥–ª—è –ø–ª–µ—á). –ú–æ—â–Ω–æ –≤—ã–∂–º–∏—Ç–µ —Å–µ–±—è –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ.</p>
        <p><strong>–ü–æ—á–µ–º—É —ç—Ç–æ —Ç–æ–ø:</strong> –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —É–≤–µ–ª–∏—á–∏—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å –±–∞–∑–æ–≤–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –∏ –¥–∞—Ç—å –º—ã—à—Ü–∞–º —Å—Ç–∏–º—É–ª –∫ —Ä–æ—Å—Ç—É –±–µ–∑ –∂–µ–ª–µ–∑–∞.</p>
      `,
      '–°–ø–∏–Ω–∞': `
        <h3 style="margin-top:0; color:var(--accent);">–°–∫–æ–ª—å–∂–µ–Ω–∏–µ –ø–æ –ø–æ–ª—É –Ω–∞ –∂–∏–≤–æ—Ç–µ</h3>
        <p>–≠—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å –∏ —Å–∏–ª—É —Ç—Ä–µ–Ω–∏—è –æ –ø–æ–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ—â–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —à–∏—Ä–æ—á–∞–π—à–∏–µ –º—ã—à—Ü—ã —Å–ø–∏–Ω—ã –∏ –º—ã—à—Ü—ã, —Å–≤–æ–¥—è—â–∏–µ –ª–æ–ø–∞—Ç–∫–∏. –û–Ω–æ –æ—Ç–ª–∏—á–Ω–æ –∏–º–∏—Ç–∏—Ä—É–µ—Ç –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è –∏–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é —Ç—è–≥—É.</p>
        <p><strong>–í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è:</strong> –ì–ª–∞–¥–∫–∏–π –ø–æ–ª (–ª–∞–º–∏–Ω–∞—Ç, –ø–∞—Ä–∫–µ—Ç, –ø–ª–∏—Ç–∫–∞, –ª–∏–Ω–æ–ª–µ—É–º) –∏ –ø–æ–ª–æ—Ç–µ–Ω—Ü–µ –ø–æ–¥ –≥—Ä—É–¥—å/–∂–∏–≤–æ—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–∫–æ–ª—å–∂–µ–Ω–∏—è.</p>
        <p><strong>–¢–µ—Ö–Ω–∏–∫–∞:</strong> –õ—è–≥—Ç–µ –Ω–∞ –∂–∏–≤–æ—Ç, –≤—ã—Ç—è–Ω—É–≤ —Ä—É–∫–∏ –≤–ø–µ—Ä–µ–¥ –∫–∞–∫ –º–æ–∂–Ω–æ –¥–∞–ª—å—à–µ. –í–¥–∞–≤–∏—Ç–µ –ª–∞–¥–æ–Ω–∏ –≤ –ø–æ–ª. –ù–∞–ø—Ä—è–≥–∞—è –º—ã—à—Ü—ã —Å–ø–∏–Ω—ã (–ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç–µ—Å—å –Ω–∞ —Ç—É—Ä–Ω–∏–∫–µ), —Å —Å–∏–ª–æ–π –ø–æ—Ç—è–Ω–∏—Ç–µ —Å–≤–æ–µ —Ç–µ–ª–æ –≤–ø–µ—Ä–µ–¥ –ø–æ –ø–æ–ª—É, —Å–≥–∏–±–∞—è —Ä—É–∫–∏ –≤ –ª–æ–∫—Ç—è—Ö –∏ —Å–≤–æ–¥—è –ª–æ–ø–∞—Ç–∫–∏ –≤–º–µ—Å—Ç–µ. –ù–æ–≥–∏ –¥–µ—Ä–∂–∏—Ç–µ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–º–∏, –æ–Ω–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ–º–æ–≥–∞—Ç—å. –í –ø–∏–∫–æ–≤–æ–π —Ç–æ—á–∫–µ (–∫–æ–≥–¥–∞ –ª–æ–∫—Ç–∏ –±—É–¥—É—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ—Ä–ø—É—Å–∞) –∑–∞–¥–µ—Ä–∂–∏—Ç–µ—Å—å –Ω–∞ —Å–µ–∫—É–Ω–¥—É –∏ –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç—Ç–æ–ª–∫–Ω–∏—Ç–µ—Å—å –æ–±—Ä–∞—Ç–Ω–æ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ.</p>
        <p><strong>–ü–æ—á–µ–º—É —ç—Ç–æ —Ç–æ–ø:</strong> –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤ —Å–≤–æ–µ–º —Ä–æ–¥–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ, –ø–æ–∑–≤–æ–ª—è—é—â–µ–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ –Ω–∞–≥—Ä—É–∑–∏—Ç—å —Ç—è–≥–æ–≤—ã–µ –º—ã—à—Ü—ã —Å–ø–∏–Ω—ã –±–µ–∑ –ø–µ—Ä–µ–∫–ª–∞–¥–∏–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–ª—å–∫–æ —Å–∏–ª—É —Ç—Ä–µ–Ω–∏—è –∏ –≤–µ—Å —Ç–µ–ª–∞.</p>
      `,
      '–ö–æ—Ä': `
        <h3 style="margin-top:0; color:var(--accent);">–ö–Ω–∏–∂–∫–∞</h3>
        <p>–≠—Ç–æ "–∫–æ—Ä–æ–ª—å" –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ –ø—Ä–µ—Å—Å. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å–∫—Ä—É—á–∏–≤–∞–Ω–∏–π (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ö –ø—Ä–µ—Å—Å–∞) –∏–ª–∏ –ø–æ–¥—ä–µ–º–æ–≤ –Ω–æ–≥ (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∏–∑), —Å–∫–ª–∞–¥–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –≤—Å–µ–π –ø—Ä—è–º–æ–π –º—ã—à—Ü—ã –∂–∏–≤–æ—Ç–∞ –∏ –º–æ—â–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä–æ–≤, —á—Ç–æ–±—ã —É–¥–µ—Ä–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å –Ω–∞ —è–≥–æ–¥–∏—Ü–∞—Ö.</p>
        <p><strong>–¢–µ—Ö–Ω–∏–∫–∞:</strong> –õ—è–≥—Ç–µ –Ω–∞ —Å–ø–∏–Ω—É, –Ω–æ–≥–∏ –ø—Ä—è–º—ã–µ, —Ä—É–∫–∏ –≤—ã—Ç—è–Ω—É—Ç—ã –∑–∞ –≥–æ–ª–æ–≤—É. –ü–æ—è—Å–Ω–∏—Ü–∞ –ø—Ä–∏–∂–∞—Ç–∞ –∫ –ø–æ–ª—É (—ç—Ç–æ –∏—Å—Ö–æ–¥–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è). –ù–∞ –≤—ã–¥–æ—Ö–µ –º–æ—â–Ω—ã–º –¥–≤–∏–∂–µ–Ω–∏–µ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–Ω–∏–º–∏—Ç–µ –ø—Ä—è–º—ã–µ –Ω–æ–≥–∏ –∏ –∫–æ—Ä–ø—É—Å –≤–≤–µ—Ä—Ö, —Å—Ç–∞—Ä–∞—è—Å—å –∫–æ—Å–Ω—É—Ç—å—Å—è —Ä—É–∫–∞–º–∏ —Å—Ç–æ–ø –≤ –≤–µ—Ä—Ö–Ω–µ–π —Ç–æ—á–∫–µ. –í–∞—à–µ —Ç–µ–ª–æ –¥–æ–ª–∂–Ω–æ —Å–ª–æ–∂–∏—Ç—å—Å—è –ø–æ–ø–æ–ª–∞–º, –∫–∞–∫ –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è—Å—è –∫–Ω–∏–≥–∞. –í –≤–µ—Ä—Ö–Ω–µ–π —Ç–æ—á–∫–µ –≤—ã –±–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞ —è–≥–æ–¥–∏—Ü–∞—Ö. –ú–µ–¥–ª–µ–Ω–Ω–æ –∏ –ø–æ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ, –Ω–µ —Ä–∞—Å—Å–ª–∞–±–ª—è—è –ø—Ä–µ—Å—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é.</p>
        <p><strong>–ü–æ—á–µ–º—É —ç—Ç–æ —Ç–æ–ø:</strong> –û–¥–Ω–æ –¥–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–µ—Å—å "–∫–æ—Ä—Å–µ—Ç" —Å–ø–µ—Ä–µ–¥–∏ –∏ —É—á–∏—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º —Ç–µ–ª–æ–º –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ.</p>
      `
    };

    const muscleImages = {
      '–ù–æ–≥–∏': 'images/–ù–æ–≥–∏.svg',
      '–ò–∫—Ä—ã': 'images/–ò–∫—Ä—ã.svg',
      '–ì—Ä—É–¥—å': 'images/–ì—Ä—É–¥—å.svg',
      '–°–ø–∏–Ω–∞': 'images/–°–ø–∏–Ω–∞.svg',
      '–ö–æ—Ä': 'images/–ö–æ—Ä.svg'
    };

    const exerciseConfig = {
      '–ù–æ–≥–∏': { time: 90, unilateral: true },
      '–ò–∫—Ä—ã': { time: 45, unilateral: true },
      '–ì—Ä—É–¥—å': { time: 60, unilateral: false },
      '–°–ø–∏–Ω–∞': { time: 60, unilateral: false },
      '–ö–æ—Ä': { time: 30, unilateral: false }
    };

    const trainings = ['A', 'B'];
    const sets = [1, 2, 3, 4];

    const STORAGE_KEY = 'home_workout_table_v1';
    const STATS_KEY = 'home_workout_stats_v1';

    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};

    const keyOf = (m, t, s) => `${m}_${t}_${s}`;

    function render() {
      const table = document.getElementById('log');
      table.innerHTML = '';

      const thead = document.createElement('thead');
      thead.innerHTML = `<tr><th>–ú—ã—à—Ü—ã</th>${trainings.map(t => sets.map(s => `<th>${t}${s}</th>`).join('')).join('')}</tr>`;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      muscles.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="group" onclick="openModal('${m}')">${m}</td>`;

        trainings.forEach(t => sets.forEach(s => {
          const key = keyOf(m, t, s);
          const cell = state[key] || { reps: '', done: false };
          const td = document.createElement('td');
          td.innerHTML = `
        <div class="cell">
          <input type="number" value="${cell.reps}" onchange="setReps('${key}',this.value)">
          <button class="set ${cell.done ? 'done' : ''}" onclick="toggle('${key}',this)">‚úì</button>
        </div>`;
          tr.appendChild(td);
        }));

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
    }

    function setReps(key, val) {
      state[key] = state[key] || { reps: '', done: false };
      state[key].reps = val;
    }

    function toggle(key, btn) {
      state[key] = state[key] || { reps: '', done: false };
      state[key].done = !state[key].done;
      btn.classList.toggle('done');

      if (state[key].done) {
        const stats = JSON.parse(localStorage.getItem(STATS_KEY)) || [];
        stats.push({ key, reps: Number(state[key].reps) || 0, ts: Date.now() });
        localStorage.setItem(STATS_KEY, JSON.stringify(stats));
        renderStats();
      }
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function resetData() {
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) return;
      localStorage.clear();
      state = {};
      render();
      renderStats();
    }

    let currentMuscle = ''; // Ensure variable exists
    let isSecondSide = false;

    function openModal(muscle) {
      currentMuscle = muscle;
      isSecondSide = false;
      document.getElementById('modalTitle').innerText = muscle;
      document.getElementById('modalImg').src = muscleImages[muscle];
      document.getElementById('modalDesc').innerHTML = muscleDescriptions[muscle] || '';
      document.getElementById('modal').style.display = 'block';

      // Data
      const config = exerciseConfig[muscle] || { time: 60, unilateral: false };
      currentBaseTime = config.time;

      // Side Reminder
      const alertBox = document.getElementById('sideAlert');
      if (config.unilateral) {
        alertBox.style.display = 'block';
        alertBox.innerText = '‚ö†Ô∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥—É—é —Å—Ç–æ—Ä–æ–Ω—É –ø–æ–æ—á–µ—Ä–µ–¥–Ω–æ';
        alertBox.style.borderColor = 'var(--accent)';
        alertBox.style.color = 'var(--accent)';
      } else {
        alertBox.style.display = 'none';
      }

      resetTimer();
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
      stopTimer(); // Ensure timer stops when closing
    }

    // Timer Logic
    let timerInterval = null;
    let timerTime = 0;
    let currentBaseTime = 60;
    let timerRunning = false;
    let timerIsCountdown = true;

    function formatTime(t) {
      const m = Math.floor(Math.abs(t) / 60).toString().padStart(2, '0');
      const s = (Math.abs(t) % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    function updateTimerDisplay() {
      document.getElementById('timerDisplay').innerText = formatTime(timerTime);
    }

    function toggleTimer() {
      if (timerRunning) {
        stopTimer();
      } else {
        startTimer();
      }
    }

    function startTimer() {
      if (timerRunning) return;

      // Reset timer if starting from 0 (e.g. for second side or next set)
      if (timerTime <= 0 && timerIsCountdown) {
        timerTime = currentBaseTime;
        updateTimerDisplay();

        // Reset side alert message if applicable
        if (exerciseConfig[currentMuscle]?.unilateral) {
          const alertBox = document.getElementById('sideAlert');
          alertBox.innerText = '‚ö†Ô∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥—É—é —Å—Ç–æ—Ä–æ–Ω—É –ø–æ–æ—á–µ—Ä–µ–¥–Ω–æ';
          alertBox.style.borderColor = 'var(--accent)';
          alertBox.style.color = 'var(--accent)';
        }
      }

      timerRunning = true;
      const btn = document.getElementById('timerToggleBtn');
      btn.innerText = 'Pause';
      btn.classList.add('active');

      timerInterval = setInterval(() => {
        if (timerIsCountdown) {
          // Sound effects (louder and improved timing)
          if (timerTime > 4) {
            playSound(1200, 0.1, 'sine', 0.5); // Louder tick
          } else if (timerTime > 0) {
            playSound(600, 0.2, 'sine', 0.5); // Countdown beeps
          }

          timerTime--;

          if (timerTime <= 0) {
            timerTime = 0;
            playSound(800, 0.6, 'square', 0.4); // Finish sound
            stopTimer();

            // Unilateral check & Auto-log
            const config = exerciseConfig[currentMuscle];
            const isUnilateral = config && config.unilateral;

            if (isUnilateral) {
              if (!isSecondSide) {
                isSecondSide = true;
                const alertBox = document.getElementById('sideAlert');
                alertBox.innerText = 'üîÑ –ü–ï–†–ï–ú–ï–ù–ê –°–¢–û–†–û–ù! –¢–ï–ü–ï–†–¨ –î–†–£–ì–ê–Ø –ù–û–ì–ê';
                alertBox.style.borderColor = '#fbbf24';
                alertBox.style.color = '#fbbf24';
                return;
              } else {
                isSecondSide = false;
                document.getElementById('sideAlert').style.display = 'none';
              }
            }

            autoFillCurrentSet(currentMuscle, currentBaseTime);
          }
        } else {
          timerTime++;
        }
        updateTimerDisplay();
      }, 1000);
    }

    // Audio Context & Zapper Logic
    let audioCtx = null;

    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') audioCtx.resume();
      return audioCtx;
    }

    function playSound(freq, duration, type, vol = 1) {
      const ctx = initAudio();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      gain.gain.setValueAtTime(vol, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + duration);
      osc.stop(ctx.currentTime + duration);
    }

    const zapper = {
      active: false,
      nodes: [],
      analyser: null,
      dataArray: null,
      animationId: null,

      toggle() {
        if (this.active) this.stop();
        else this.start();
        this.updateUI();
      },

      start() {
        const ctx = initAudio();
        this.nodes = [];
        this.audioStartTime = ctx.currentTime;

        // Output & Analyser Setup
        const masterGain = ctx.createGain();
        masterGain.gain.value = 1.0;
        masterGain.connect(ctx.destination);
        this.nodes.push(masterGain);

        this.analyser = ctx.createAnalyser();
        this.analyser.fftSize = 256;
        masterGain.connect(this.analyser);

        const bufferLength = this.analyser.frequencyBinCount;
        this.dataArray = new Uint8Array(bufferLength);

        // 1. 30kHz Square Wave
        const mainOsc = ctx.createOscillator();
        mainOsc.type = 'square';
        mainOsc.frequency.value = 30000;

        const offset = ctx.createConstantSource ? ctx.createConstantSource() : ctx.createOscillator();
        if (offset.offset) offset.offset.value = 1;
        else { offset.frequency.value = 0; offset.setPeriodicWave(ctx.createPeriodicWave(new Float32Array([1, 1]), new Float32Array([0, 0]))); }

        const combiner = ctx.createGain();
        combiner.gain.value = 0.5;

        mainOsc.connect(combiner);
        offset.connect(combiner);
        combiner.connect(masterGain);

        mainOsc.start();
        offset.start();
        this.nodes.push(mainOsc, offset, combiner);

        // 2. High Frequencies Sweep
        this.sweepRanges = [[77000, 400000], [350000, 500000], [500000, 900000]];
        this.sweepRanges.forEach(([min, max]) => {
          const sweepOsc = ctx.createOscillator();
          sweepOsc.type = 'square';
          sweepOsc.frequency.value = (min + max) / 2;

          const lfo = ctx.createOscillator();
          lfo.type = 'triangle';
          lfo.frequency.value = 0.2; // 5s period

          const lfoGain = ctx.createGain();
          lfoGain.gain.value = (max - min) / 2;

          lfo.connect(lfoGain);
          lfoGain.connect(sweepOsc.frequency);

          const vol = ctx.createGain();
          vol.gain.value = 0.1;

          sweepOsc.connect(vol);
          vol.connect(masterGain);

          sweepOsc.start();
          lfo.start();
          this.nodes.push(sweepOsc, lfo, lfoGain, vol);
        });

        this.active = true;
        this.drawScope();
      },

      stop() {
        if (this.animationId) cancelAnimationFrame(this.animationId);
        this.nodes.forEach(n => {
          try { n.stop(); } catch (e) { }
          n.disconnect();
        });
        if (this.analyser) this.analyser.disconnect();
        this.nodes = [];
        this.active = false;

        // Clear canvas
        const canvas = document.getElementById('zapperScope');
        const cCtx = canvas.getContext('2d');
        cCtx.clearRect(0, 0, canvas.width, canvas.height);
      },

      drawScope() {
        if (!this.active) return;
        this.animationId = requestAnimationFrame(() => this.drawScope());

        const canvas = document.getElementById('zapperScope');
        const cCtx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        // Get Audio Time for Sync
        const ctx = this.nodes[0] ? this.nodes[0].context : null;
        if (!ctx) return;
        const elapsed = ctx.currentTime - this.audioStartTime;

        cCtx.fillStyle = '#020617';
        cCtx.fillRect(0, 0, width, height);

        // Grid / Zero
        cCtx.lineWidth = 1;
        cCtx.strokeStyle = '#1f2937';
        cCtx.beginPath();
        cCtx.moveTo(0, height / 2);
        cCtx.lineTo(width, height / 2);
        cCtx.stroke();

        // Calculate Frequencies matching LFO (Triangle, 0.2Hz)
        // Triangle LFO Waveform reference: zero -> pos peak -> zero -> neg peak -> zero
        // WebAudio triangle LFO starts at 0 going positive.
        // Period = 1/0.2 = 5s.
        // Normalized LFO value (-1 to 1) at time t:
        // phase = (t * 0.2 * 4) % 4; // 4 segments: 0-1, 1-0, 0--1, -1-0? No.
        // Easier: value = (2/PI) * asin(sin(2*PI * f * t)); This is triangle wave formula -1 to 1.
        const lfoVal = (2 / Math.PI) * Math.asin(Math.sin(2 * Math.PI * 0.2 * elapsed));

        const freqs = [30000];
        this.sweepRanges.forEach(([min, max]) => {
          const center = (min + max) / 2;
          const range = (max - min) / 2;
          freqs.push(center + range * lfoVal);
        });

        // Draw Frequencies Text
        cCtx.font = '10px monospace';
        cCtx.fillStyle = '#38bdf8';
        cCtx.textAlign = 'left';

        // 30kHz
        cCtx.fillText('30 kHz', 4, 10);
        // Sw1
        cCtx.fillText((freqs[1] / 1000).toFixed(0) + ' kHz', 4, 22);

        cCtx.textAlign = 'right';
        // Sw2
        cCtx.fillText((freqs[2] / 1000).toFixed(0) + ' kHz', width - 4, 10);
        // Sw3
        cCtx.fillText((freqs[3] / 1000).toFixed(0) + ' kHz', width - 4, 22);


        // Draw Composite Waveform
        // Since we can't see 30kHz-1MHz on 44kHz sample rate, we simulate the visualization
        // by scaling the time base down to visible frequencies, but keeping relative ratios (ish).
        // Base visual freq: 30kHz -> represented as 3Hz visual wave?

        cCtx.beginPath();
        cCtx.lineWidth = 1.5;
        cCtx.strokeStyle = '#22c55e';
        cCtx.shadowBlur = 4;
        cCtx.shadowColor = 'rgba(34, 197, 94, 0.5)';

        const timeScale = elapsed * 10;

        for (let x = 0; x < width; x++) {
          let y = 0;
          // Normalized X
          const t = x / width;

          // 1. 30kHz Square Base (Visualized as a stable square wave)
          // We'll give it a fixed visual frequency, e.g., 4 cycles across screen
          const basePhase = (t * 4 - timeScale) * Math.PI * 2;
          y += Math.sign(Math.sin(basePhase)) * 0.4;

          // 2. Add Sweeps (Visualized as higher freq sines/noise)
          // Scale visual freq by actual freq ratio relative to 30k
          // 30k = 1. 300k = 10.

          // To prevent chaos, we clamp visual multiplier or it just becomes fill.
          // Let's just add 3 "high freq" components that vary with the calculated freqs
          // scaled down heavily.

          for (let i = 1; i < 4; i++) {
            // Ratio relative to 30k
            const ratio = freqs[i] / 30000;
            // Visual freq
            const vf = 4 * ratio;
            const amp = 0.15; // lower amplitude for sweeps
            y += Math.sin((t * vf - timeScale * ratio) * Math.PI * 2) * amp;
          }

          // Map -1..1 to Height
          // Canvas Height is small (40px). 
          const plotY = (height / 2) - (y * (height / 2.5));

          if (x === 0) cCtx.moveTo(x, plotY);
          else cCtx.lineTo(x, plotY);
        }
        cCtx.stroke();
        cCtx.shadowBlur = 0;
      },

      updateUI() {
        const btn = document.getElementById('zapperBtn');
        const icon = document.getElementById('zapperIcon');
        const canvas = document.getElementById('zapperScope');

        if (this.active) {
          icon.style.opacity = '1';
          icon.style.filter = 'drop-shadow(0 0 5px #38bdf8)';
          btn.style.borderColor = 'var(--accent)';
          btn.style.color = 'var(--accent)';
          canvas.style.display = 'block';
        } else {
          icon.style.opacity = '0.5';
          icon.style.filter = 'none';
          btn.style.borderColor = 'var(--border)';
          btn.style.color = 'var(--text)';
          canvas.style.display = 'none';
        }
      }
    };

    function toggleZapper() {
      zapper.toggle();
    }

    function stopTimer() {
      timerRunning = false;
      if (timerInterval) clearInterval(timerInterval);
      const btn = document.getElementById('timerToggleBtn');
      if (btn) {
        btn.innerText = 'Start';
        btn.classList.remove('active');
      }
    }

    function resetTimer() {
      stopTimer();
      timerTime = currentBaseTime;
      timerIsCountdown = true;
      updateTimerDisplay();
    }

    function addTime(seconds) {
      // If we add time, we assume the user wants a countdown (e.g. for rest)
      if (!timerIsCountdown && timerTime === 0) {
        timerIsCountdown = true;
      }

      // If was stopwatch (counting up) and we add time, switching to countdown might be confusing if we don't reset.
      // But typically "add 30s" implies "I want a timer for 30s".
      // Let's simpler logic: always add to current time constant.

      if (!timerIsCountdown && timerTime > 0) {
        // If we were counting up, and user clicks +30s, do we convert to countdown?
        // Or just add 30s to the elapsed time?
        // Usually in workout app, +30s button is for REST timer.
        // So let's force countdown mode.
        timerIsCountdown = true;
      }

      // If switching from stopwatch 0 to countdown, it's fine.
      timerIsCountdown = true;
      timerTime += seconds;
      updateTimerDisplay();
      if (!timerRunning) startTimer();
    }

    function renderStats() {
      const stats = JSON.parse(localStorage.getItem(STATS_KEY)) || [];
      const box = document.getElementById('stats');

      if (!stats.length) { box.innerHTML = '<span class="subtitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—É—Å—Ç–∞</span>'; return; }

      const sum = {};
      stats.forEach(e => {
        const m = e.key.split('_')[0];
        sum[m] = sum[m] || { sets: 0, reps: 0 };
        sum[m].sets++; sum[m].reps += e.reps;
      });

      box.innerHTML = `
    <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
    <div class="stats-grid">
      ${Object.entries(sum).map(([m, v]) => `
        <div class="stat">
          <div class="label">${m}</div>
          <div class="value">${v.sets} ¬∑ ${v.reps}</div>
        </div>`).join('')}
    </div>`;
    }

    function autoFillCurrentSet(muscle, value) {
      // Find first empty slot
      for (let t of trainings) { // ['A', 'B']
        for (let s of sets) { // [1, 2, 3, 4]
          const key = keyOf(muscle, t, s);
          const cell = state[key];
          // Fill if cell doesn't exist or reps is empty
          if (!cell || !cell.reps) {
            setReps(key, value);
            render();
            return;
          }
        }
      }
    }

    render();
    renderStats();
  </script>
</body>

</html>