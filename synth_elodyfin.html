<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVOLUTIONARY AUDIO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Times New Roman', serif; user-select: none; }
        #canvas-container { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: radial-gradient(circle, transparent 0%, #000 100%);
            pointer-events: none;
        }

        h1 {
            color: #fff; font-size: 4em; font-weight: 100; letter-spacing: 20px;
            text-transform: uppercase; margin: 0; opacity: 0.9;
            text-shadow: 0 0 40px rgba(255,255,255,0.2);
            transition: color 0.5s;
        }

        .subtitle {
            color: #d4af37; font-size: 1em; letter-spacing: 5px; margin-top: 20px;
            text-transform: uppercase; transition: color 0.5s;
        }

        /* Initial Start Button */
        #startBtn {
            pointer-events: auto; margin-top: 60px;
            background: transparent; color: #d4af37; 
            border: 1px solid #d4af37; padding: 15px 50px;
            font-family: inherit; font-size: 0.9em; letter-spacing: 4px; 
            cursor: pointer; transition: all 0.5s;
        }
        #startBtn:hover { background: rgba(212, 175, 55, 0.1); box-shadow: 0 0 50px rgba(212, 175, 55, 0.2); }

        /* Evolution Controls */
        .evolution-controls {
            position: absolute; bottom: 50px; width: 100%; text-align: center;
            z-index: 30; pointer-events: none; opacity: 0; transition: opacity 1s;
            display: flex; justify-content: center; gap: 20px;
        }

        .evo-btn {
            pointer-events: auto; background: rgba(0,0,0,0.8); color: #fff;
            border: 1px solid #fff; padding: 15px 30px; min-width: 150px;
            font-family: 'Courier New', monospace; font-size: 1em; letter-spacing: 2px;
            cursor: pointer; transition: all 0.3s; text-transform: uppercase;
        }
        
        #btn-evolve { border-color: #00ffff; color: #00ffff; box-shadow: 0 0 10px rgba(0, 255, 255, 0.2); }
        #btn-evolve:hover { background: #00ffff; color: #000; box-shadow: 0 0 30px #00ffff; }

        #btn-approve { border-color: #00ff00; color: #00ff00; display: none; }
        #btn-approve:hover { background: #00ff00; color: #000; box-shadow: 0 0 30px #00ff00; }

        #btn-reject { border-color: #ff0000; color: #ff0000; display: none; }
        #btn-reject:hover { background: #ff0000; color: #000; box-shadow: 0 0 30px #ff0000; }

        .gen-info {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            color: #666; font-family: 'Courier New', monospace; font-size: 0.8em;
        }
        #gen-val { color: #fff; }

    </style>
</head>
<body>

<div id="canvas-container"></div>

<div class="gen-info">GENERATION: <span id="gen-val">0</span></div>

<div class="ui-layer" id="ui">
    <h1 id="mainTitle">GENESIS</h1>
    <div class="subtitle" id="subTitle">Neural Evolution Engine</div>
    <button id="startBtn">INITIALIZE SYSTEM</button>
</div>

<div class="evolution-controls" id="evoControls">
    <button class="evo-btn" id="btn-reject">CRITICIZE (REVERT)</button>
    <button class="evo-btn" id="btn-evolve">EVOLVE (MUTATE)</button>
    <button class="evo-btn" id="btn-approve">APPROVE (KEEP)</button>
</div>

<!-- SHADER: Evolutionary Particles -->
<script type="x-shader/x-vertex" id="vShader">
    attribute float aIdx;
    attribute float aSize;
    
    uniform float uTime;
    uniform float uBass;
    uniform float uHigh;
    
    // Genome Uniforms
    uniform float uSpeed;
    uniform float uSpread;
    uniform vec3 uColor1;
    uniform vec3 uColor2;
    
    varying float vAlpha;
    varying vec3 vColor;

    const float PHI = 1.61803398875;
    const float PI = 3.14159265359;

    void main() {
        // Fibonacci Sphere Distribution with Genome Spread
        float y = 1.0 - (aIdx / 5000.0) * 2.0;
        float radius = sqrt(1.0 - y * y) * uSpread;
        float theta = PHI * aIdx * 2.0 * PI;
        
        float x = cos(theta) * radius;
        float z = sin(theta) * radius;
        
        vec3 pos = vec3(x, y, z);
        
        // Expansion (Breathing)
        float breathe = 1.0 + sin(uTime * 0.5 + pos.y * 2.0) * 0.1;
        breathe += uBass * 0.5 * smoothstep(0.0, 1.0, abs(pos.y));
        
        pos *= 20.0 * breathe; 
        
        // Rotation based on Genome Speed
        float rot = uTime * uSpeed;
        float c = cos(rot); float s = sin(rot);
        vec3 finalPos = vec3(pos.x * c + pos.z * s, pos.y, -pos.x * s + pos.z * c);

        vec4 mvPosition = modelViewMatrix * vec4(finalPos, 1.0);
        gl_PointSize = aSize * (300.0 / -mvPosition.z);
        gl_Position = projectionMatrix * mvPosition;

        // Genome Colors
        vColor = mix(uColor1, uColor2, smoothstep(-1.0, 1.0, y + sin(uTime)*0.5));
        
        vAlpha = 0.5 + 0.5 * sin(uTime * 5.0 + aIdx);
    }
</script>

<script type="x-shader/x-fragment" id="fShader">
    varying float vAlpha;
    varying vec3 vColor;
    
    void main() {
        vec2 uv = gl_PointCoord.xy - 0.5;
        float dist = length(uv);
        float alpha = 1.0 - smoothstep(0.0, 0.5, dist);
        
        vec3 finalColor = vColor + vec3(0.5) * (1.0 - dist*1.5);
        gl_FragColor = vec4(finalColor, alpha * vAlpha);
    }
</script>

<script>
    // --- GENETICS ---
    let generation = 0;
    
    // The "DNA" of our world
    let currentGenome = {
        // Visuals
        hue1: 0.6, // Base Blue
        hue2: 0.1, // Base Gold
        rotationSpeed: 0.1,
        spread: 1.0,
        // Audio
        harmonicity: 1.0, // Multiplier for harmonics (1.0 = integer)
        modDepth: 100, // FM modulation
        attack: 0.02,
        decay: 3.0,
        tempo: 1.0 // Timing multiplier
    };
    
    let backupGenome = null; // To revert if rejected

    // Function to mutate the genome
    function mutate() {
        // Save current state
        backupGenome = { ...currentGenome };
        
        // Randomly alter parameters
        currentGenome.hue1 = (currentGenome.hue1 + (Math.random()-0.5)*0.5 + 1) % 1;
        currentGenome.hue2 = (currentGenome.hue2 + (Math.random()-0.5)*0.5 + 1) % 1;
        currentGenome.rotationSpeed = Math.max(0.05, Math.min(0.5, currentGenome.rotationSpeed + (Math.random()-0.5)*0.1));
        currentGenome.spread = Math.max(0.5, Math.min(2.0, currentGenome.spread + (Math.random()-0.5)*0.5));
        
        // Audio Mutations
        // Shift harmonicity (creates dissonance/consonance)
        currentGenome.harmonicity = Math.max(0.5, currentGenome.harmonicity + (Math.random()-0.5)*0.5);
        currentGenome.modDepth = Math.max(0, currentGenome.modDepth + (Math.random()-0.5)*200);
        currentGenome.decay = Math.max(0.5, Math.min(6.0, currentGenome.decay + (Math.random()-0.5)*1.0));
        
        applyGenome();
        
        generation++;
        document.getElementById('gen-val').innerText = generation + " (MUTATED)";
        
        updateUIState('evaluating');
    }

    function approve() {
        backupGenome = null; // Commit changes
        document.getElementById('gen-val').innerText = generation;
        updateUIState('idle');
    }

    function reject() {
        if(backupGenome) {
            currentGenome = { ...backupGenome };
            applyGenome();
            generation--;
            document.getElementById('gen-val').innerText = generation;
        }
        updateUIState('idle');
    }

    function applyGenome() {
        // Apply Visuals
        if(uniforms) {
            const c1 = new THREE.Color().setHSL(currentGenome.hue1, 1.0, 0.5);
            const c2 = new THREE.Color().setHSL(currentGenome.hue2, 1.0, 0.5);
            uniforms.uColor1.value = c1;
            uniforms.uColor2.value = c2;
            uniforms.uSpeed.value = currentGenome.rotationSpeed;
            uniforms.uSpread.value = currentGenome.spread;
            
            // Update Title Colors
            document.getElementById('mainTitle').style.textShadow = `0 0 30px #${c1.getHexString()}`;
            document.getElementById('subTitle').style.color = `#${c2.getHexString()}`;
            document.getElementById('startBtn').style.borderColor = `#${c2.getHexString()}`;
            document.getElementById('startBtn').style.color = `#${c2.getHexString()}`;
        }
        // Audio params are read directly from currentGenome in the audio loop
    }

    function updateUIState(state) {
        const btnEvolve = document.getElementById('btn-evolve');
        const btnApprove = document.getElementById('btn-approve');
        const btnReject = document.getElementById('btn-reject');
        
        if (state === 'evaluating') {
            btnEvolve.style.display = 'none';
            btnApprove.style.display = 'inline-block';
            btnReject.style.display = 'inline-block';
        } else {
            btnEvolve.style.display = 'inline-block';
            btnApprove.style.display = 'none';
            btnReject.style.display = 'none';
        }
    }

    // --- THREE.JS ---
    let scene, camera, renderer, particles, uniforms;
    let clock;
    let isPlaying = false;
    
    function init3D() {
        const container = document.getElementById('canvas-container');
        clock = new THREE.Clock();
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.015);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 40;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        const count = 5000;
        const geometry = new THREE.BufferGeometry();
        const indices = [];
        const sizes = [];
        
        for(let i=0; i<count; i++) {
            indices.push(i);
            sizes.push(1.0 + Math.random() * 2.0);
        }
        
        geometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array(count*3), 3));
        geometry.setAttribute('aIdx', new THREE.Float32BufferAttribute(indices, 1));
        geometry.setAttribute('aSize', new THREE.Float32BufferAttribute(sizes, 1));

        uniforms = {
            uTime: { value: 0 },
            uBass: { value: 0 },
            uHigh: { value: 0 },
            uSpeed: { value: currentGenome.rotationSpeed },
            uSpread: { value: currentGenome.spread },
            uColor1: { value: new THREE.Color().setHSL(currentGenome.hue1, 1.0, 0.5) },
            uColor2: { value: new THREE.Color().setHSL(currentGenome.hue2, 1.0, 0.5) }
        };

        const material = new THREE.ShaderMaterial({
            vertexShader: document.getElementById('vShader').textContent,
            fragmentShader: document.getElementById('fShader').textContent,
            uniforms: uniforms,
            transparent: true,
            depthWrite: false,
            blending: THREE.AdditiveBlending
        });

        particles = new THREE.Points(geometry, material);
        scene.add(particles);

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        applyGenome(); // Apply initial colors
    }

    function animate() {
        requestAnimationFrame(animate);
        if(!clock) return;
        
        const time = clock.getElapsedTime();
        uniforms.uTime.value = time;

        if(analyser) {
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            const bass = data[4] / 255.0;
            const high = data[64] / 255.0;
            uniforms.uBass.value += (bass - uniforms.uBass.value) * 0.1;
            uniforms.uHigh.value += (high - uniforms.uHigh.value) * 0.1;
            
            camera.rotation.z = Math.sin(time * 0.1) * 0.1 + (uniforms.uHigh.value * 0.05);
        }

        renderer.render(scene, camera);
    }

    // --- AUDIO ENGINE ---
    let ac, master, limiter;
    let reverbNode, analyser;
    const FUNDAMENTAL = 130.81;
    // Base ratios, genome will morph these
    const RATIOS = [1, 9/8, 5/4, 1.333, 1.5, 1.666, 1.875, 2];
    
    function initAudio() {
        ac = new (window.AudioContext || window.webkitAudioContext)();
        master = ac.createGain();
        master.gain.value = 0.4;
        
        limiter = ac.createDynamicsCompressor();
        limiter.threshold.value = -3;
        limiter.ratio.value = 12;

        const len = ac.sampleRate * 4;
        const buf = ac.createBuffer(2, len, ac.sampleRate);
        for(let i=0; i<len; i++) {
            const d = Math.pow(1 - i/len, 3);
            buf.getChannelData(0)[i] = (Math.random()*2-1)*d;
            buf.getChannelData(1)[i] = (Math.random()*2-1)*d;
        }
        reverbNode = ac.createConvolver();
        reverbNode.buffer = buf;
        
        const revMix = ac.createGain();
        revMix.gain.value = 0.5;

        master.connect(limiter);
        limiter.connect(ac.destination);
        master.connect(reverbNode);
        reverbNode.connect(revMix);
        revMix.connect(limiter);

        analyser = ac.createAnalyser();
        analyser.fftSize = 256;
        analyser.smoothingTimeConstant = 0.9;
        limiter.connect(analyser);

        scheduleNextNote();
        startDrone();
    }

    function playBell(freq, time) {
        if(!ac) return;
        
        // Ratios mutated by genome.harmonicity
        // If harmonicity = 1.0, ratios are integers/clean. 
        // If !1.0, inharmonic/metallic.
        const hMult = currentGenome.harmonicity;
        const harmonics = [1, 2*hMult, 3*hMult, 4.2*hMult];
        const amps = [1, 0.5, 0.3, 0.1];
        
        const gain = ac.createGain();
        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(0.2, time + currentGenome.attack);
        gain.gain.exponentialRampToValueAtTime(0.001, time + currentGenome.decay);
        
        harmonics.forEach((h, i) => {
            const osc = ac.createOscillator();
            osc.type = 'sine';
            osc.frequency.value = freq * h;
            
            const hGain = ac.createGain();
            hGain.gain.value = amps[i];
            
            osc.connect(hGain);
            hGain.connect(gain);
            osc.start(time);
            osc.stop(time + currentGenome.decay);
        });

        // FM Layer modulated by genome
        const mod = ac.createOscillator();
        mod.frequency.value = freq * 2.5 * hMult; 
        const modG = ac.createGain();
        modG.gain.setValueAtTime(currentGenome.modDepth, time);
        modG.gain.exponentialRampToValueAtTime(0.01, time + 0.2); 
        
        const carrier = ac.createOscillator();
        carrier.frequency.value = freq;
        mod.connect(modG);
        modG.connect(carrier.frequency);
        carrier.connect(gain);
        mod.start(time); carrier.start(time);
        mod.stop(time+0.2); carrier.stop(time+0.2);
        
        gain.connect(master);
    }

    function startDrone() {
        const root = FUNDAMENTAL / 2;
        const oscL = ac.createOscillator(); const oscR = ac.createOscillator();
        oscL.type = 'triangle'; oscR.type = 'triangle';
        oscL.frequency.value = root; oscR.frequency.value = root + 0.2; 
        const panL = ac.createStereoPanner(); panL.pan.value = -0.8;
        const panR = ac.createStereoPanner(); panR.pan.value = 0.8;
        const gain = ac.createGain();
        gain.gain.value = 0;
        gain.gain.setTargetAtTime(0.15, ac.currentTime, 5); 
        
        const filter = ac.createBiquadFilter();
        filter.type = 'lowpass'; filter.frequency.value = 200;
        
        const lfo = ac.createOscillator(); lfo.frequency.value = 0.1;
        const lfoG = ac.createGain(); lfoG.gain.value = 100;
        lfo.connect(lfoG); lfoG.connect(filter.frequency); lfo.start();

        oscL.connect(panL); panL.connect(filter);
        oscR.connect(panR); panR.connect(filter);
        filter.connect(gain); gain.connect(master);
        oscL.start(); oscR.start();
    }

    let currentNoteIdx = 0;
    
    function getNextNote() {
        const r = Math.random();
        let step = 0;
        if (r < 0.3) step = 0;
        else if (r < 0.6) step = 1;
        else if (r < 0.8) step = -1;
        else if (r < 0.9) step = 2;
        else step = -2;
        
        let nextIdx = currentNoteIdx + step;
        if (nextIdx < 0) nextIdx = 0;
        if (nextIdx > 14) nextIdx = 14;
        currentNoteIdx = nextIdx;
        
        const octave = Math.floor(nextIdx / 7);
        const degree = nextIdx % 7;
        const ratio = RATIOS[degree];
        return FUNDAMENTAL * Math.pow(2, octave) * ratio;
    }

    function scheduleNextNote() {
        if(!isPlaying) return;
        const now = ac.currentTime;
        const freq = getNextNote();
        // Timing adjusted by genome tempo? (simplified here)
        const wait = 0.2 + Math.random() * 0.8; 
        playBell(freq * 2, now); 
        if(Math.random() > 0.7) playBell(freq / 2, now + 0.1);
        setTimeout(scheduleNextNote, wait * 1000);
    }

    // --- BUTTON BINDINGS ---
    document.getElementById('startBtn').addEventListener('click', () => {
        const ui = document.getElementById('ui');
        ui.style.opacity = 0;
        setTimeout(() => ui.style.display = 'none', 1500);
        document.getElementById('evoControls').style.opacity = 1;

        init3D();
        initAudio();
        
        if(ac.state === 'suspended') ac.resume();
        isPlaying = true;
        animate();
    });

    document.getElementById('btn-evolve').addEventListener('click', mutate);
    document.getElementById('btn-approve').addEventListener('click', approve);
    document.getElementById('btn-reject').addEventListener('click', reject);

</script>
</body>
</html>
