<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINETIC STORM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { 
            margin: 0; overflow: hidden; background: #000; 
            font-family: 'Segoe UI', sans-serif; cursor: crosshair; 
            user-select: none;
        }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: rgba(0,0,0,0.8);
            transition: opacity 0.5s;
            backdrop-filter: blur(5px);
        }

        h1 {
            color: #fff; font-size: 5vw; margin: 0; line-height: 0.9;
            text-transform: uppercase; font-weight: 900; letter-spacing: -2px;
            text-shadow: 0 0 20px #00ffff;
            animation: pulse 2s infinite;
        }

        .subtitle {
            color: #ff00ff; font-size: 1.2rem; letter-spacing: 5px; margin-top: 20px;
            font-weight: bold; text-transform: uppercase;
        }

        #startBtn {
            margin-top: 50px;
            background: transparent; color: #fff; border: 2px solid #fff; 
            padding: 20px 80px; font-size: 1.5rem; font-weight: 900; 
            cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            box-shadow: 0 0 20px #fff; transition: all 0.2s;
        }
        #startBtn:hover { background: #fff; color: #000; box-shadow: 0 0 50px #00ffff; transform: scale(1.05); }

        /* HUD */
        .hud-left {
            position: absolute; bottom: 30px; left: 30px; z-index: 10;
            color: #fff; font-family: monospace; font-size: 1rem;
            pointer-events: none; opacity: 0; transition: opacity 1s;
        }
        
        .bar-container {
            width: 300px; height: 10px; background: #222; margin-top: 5px;
            border: 1px solid #555; transform: skewX(-20deg);
        }
        .bar-fill {
            width: 0%; height: 100%; background: linear-gradient(90deg, #00ffff, #ff00ff);
            box-shadow: 0 0 15px #ff00ff; transition: width 0.05s linear;
        }

        .hint-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.5s;
        }
        .hint-text {
            color: rgba(255,255,255,0.3); font-size: 2rem; font-weight: 900;
            letter-spacing: 10px; text-transform: uppercase;
        }

        @keyframes pulse {
            0% { text-shadow: 0 0 20px #00ffff; }
            50% { text-shadow: 0 0 50px #ff00ff, 0 0 80px #00ffff; }
            100% { text-shadow: 0 0 20px #00ffff; }
        }
    </style>
</head>
<body>

<div id="canvas-container"></div>

<div class="ui-layer" id="ui">
    <h1>KINETIC<br>STORM</h1>
    <div class="subtitle">Vertical Evolution Engine</div>
    <button id="startBtn">ENGAGE SYSTEM</button>
</div>

<div class="hint-overlay" id="hintBox">
    <div class="hint-text">MOVE MOUSE UP TO EVOLVE</div>
</div>

<div class="hud-left" id="hud">
    EVOLUTION: <span id="evoVal">0%</span>
    <div class="bar-container"><div class="bar-fill" id="evoBar"></div></div>
    <br>
    DISTORTION: <span id="distVal">0%</span>
    <div class="bar-container"><div class="bar-fill" id="distBar" style="background:#ff0000;"></div></div>
</div>

<!-- VERTEX SHADER -->
<script type="x-shader/x-vertex" id="vShader">
    varying vec2 vUv;
    varying vec3 vColor;
    varying float vAlpha;
    varying float vDist;

    uniform float uTime;
    uniform float uSpeed;
    uniform float uBass;     
    uniform float uEvo; // 0.0 - 1.0 (Mouse Y)
    uniform float uDistort; // -1.0 - 1.0 (Mouse X)

    attribute float aSize;
    attribute vec3 aColor;
    attribute float aOffset; 
    attribute float aAngle;

    void main() {
        vUv = uv;
        vec3 pos = position;
        
        // 1. Infinite Tunnel
        float zPos = mod(pos.z + uTime * uSpeed + aOffset, 1000.0) - 800.0;
        pos.z = zPos;

        // 2. Evolution Expansion (Breathing Tunnel)
        float expansion = 1.0 + uEvo * 2.0; 
        
        // 3. Twist & Distort (Mouse X)
        float twist = zPos * 0.005 * uDistort;
        float s = sin(twist);
        float c = cos(twist);
        float nx = pos.x * c - pos.y * s;
        float ny = pos.x * s + pos.y * c;
        
        // Apply expansion
        pos.x = nx * expansion;
        pos.y = ny * expansion;

        // 4. Chaos (Spikes on high evolution)
        if(uEvo > 0.5) {
             float chaos = sin(uTime * 20.0 + aOffset) * (uEvo - 0.5) * 5.0;
             pos.x += chaos;
             pos.y += chaos;
        }

        // 5. Bass Pulse
        float pulse = 1.0 + uBass * 0.2 * (0.5 + uEvo); 
        pos.xy *= pulse;

        vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
        
        // Size Attenuation
        gl_PointSize = (aSize * (1.0 + uEvo)) * (400.0 / -mvPosition.z);
        gl_Position = projectionMatrix * mvPosition;
        
        // Pass to fragment
        vColor = aColor;
        vDist = zPos;
    }
</script>

<!-- FRAGMENT SHADER -->
<script type="x-shader/x-fragment" id="fShader">
    varying vec3 vColor;
    varying float vDist;
    
    uniform float uEvo;
    uniform float uBass;

    void main() {
        vec2 uv = gl_PointCoord.xy - 0.5;
        float dist = length(uv);
        if (dist > 0.5) discard;
        
        // Glow
        float glow = 1.0 - (dist * 2.0);
        glow = pow(glow, 2.0);
        
        // Color Modulation
        vec3 finalColor = vColor;
        
        // Shift towards Red/White at high evolution
        vec3 hotColor = vec3(1.0, 0.8, 0.5); // Gold/White
        finalColor = mix(finalColor, hotColor, uEvo * 0.8);
        
        // Bass Flash
        finalColor += vec3(uBass * 0.4 * uEvo);

        // Distance Fog
        float alpha = smoothstep(-900.0, -700.0, vDist) * (1.0 - smoothstep(100.0, 200.0, vDist));

        gl_FragColor = vec4(finalColor, alpha * glow);
    }
</script>

<script>
    // --- GLOBAL VARS ---
    let isPlaying = false;
    let evolution = 0; // 0 to 1
    let distortion = 0; // -1 to 1
    let targetEvolution = 0;
    let targetDistortion = 0;

    // --- THREE.JS ---
    let scene, camera, renderer, clock;
    let tunnelSystem, uniforms;

    // --- AUDIO ---
    let ac, master, filter, limiter, analyser;
    let reverb;
    let nextNoteTime = 0;
    let step = 0;

    // --- MOUSE INPUT ---
    function onMouseMove(e) {
        // Y = Evolution (Inverted: Top is 1.0)
        let y = 1.0 - (e.clientY / window.innerHeight);
        targetEvolution = Math.max(0, Math.min(1, y));

        // X = Distortion
        let x = (e.clientX / window.innerWidth) * 2 - 1;
        targetDistortion = x * 2.0; // Amplify effect
    }
    
    function onTouchMove(e) {
        e.preventDefault();
        let t = e.touches[0];
        let y = 1.0 - (t.clientY / window.innerHeight);
        targetEvolution = Math.max(0, Math.min(1, y));
        let x = (t.clientX / window.innerWidth) * 2 - 1;
        targetDistortion = x * 2.0;
    }

    // --- 3D ENGINE ---
    function init3D() {
        const container = document.getElementById('canvas-container');
        clock = new THREE.Clock();
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.002);

        camera = new THREE.PerspectiveCamera(80, window.innerWidth/window.innerHeight, 0.1, 2000);
        camera.position.z = 100;

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        container.appendChild(renderer.domElement);

        // PARTICLES
        const geo = new THREE.BufferGeometry();
        const count = 15000;
        const pos = [];
        const sizes = [];
        const colors = [];
        const offsets = [];

        const c1 = new THREE.Color(0x00ffff); // Cyan
        const c2 = new THREE.Color(0x0000ff); // Blue

        for(let i=0; i<count; i++) {
            const angle = Math.random() * Math.PI * 2;
            const r = 10 + Math.random() * 40; // Initial tight tunnel
            const x = Math.cos(angle) * r;
            const y = Math.sin(angle) * r;
            const z = (Math.random() - 0.5) * 2000;
            
            pos.push(x, y, z);
            sizes.push(Math.random() * 3.0 + 1.0);
            offsets.push(Math.random() * 1000);

            // Random mix
            const col = c1.clone().lerp(c2, Math.random());
            colors.push(col.r, col.g, col.b);
        }

        geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
        geo.setAttribute('aSize', new THREE.Float32BufferAttribute(sizes, 1));
        geo.setAttribute('aColor', new THREE.Float32BufferAttribute(colors, 3));
        geo.setAttribute('aOffset', new THREE.Float32BufferAttribute(offsets, 1));

        uniforms = {
            uTime: { value: 0 },
            uSpeed: { value: 50 },
            uBass: { value: 0 },
            uEvo: { value: 0 },
            uDistort: { value: 0 }
        };

        const mat = new THREE.ShaderMaterial({
            vertexShader: document.getElementById('vShader').textContent,
            fragmentShader: document.getElementById('fShader').textContent,
            uniforms: uniforms,
            transparent: true,
            depthWrite: false,
            blending: THREE.AdditiveBlending
        });

        tunnelSystem = new THREE.Points(geo, mat);
        scene.add(tunnelSystem);

        window.addEventListener('resize', onResize);
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('touchmove', onTouchMove, {passive: false});
    }

    function onResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        if(!clock) return;

        const time = clock.getElapsedTime();
        
        // Smooth inputs
        evolution += (targetEvolution - evolution) * 0.1;
        distortion += (targetDistortion - distortion) * 0.1;

        // Visual Params
        uniforms.uTime.value = time;
        uniforms.uSpeed.value = 50 + (evolution * 800); // Massive speedup
        uniforms.uEvo.value = evolution;
        uniforms.uDistort.value = distortion;

        // Audio Reactivity
        if(analyser) {
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            const bass = data[3] / 255.0; 
            uniforms.uBass.value += (bass - uniforms.uBass.value) * 0.3;
            
            // Audio Params Automation
            // Filter follows evolution
            const targetFreq = 100 + (Math.pow(evolution, 2) * 15000); 
            filter.frequency.setTargetAtTime(targetFreq, ac.currentTime, 0.1);
            
            // Camera Shake on Bass + High Evo
            if (bass > 0.6 && evolution > 0.2) {
                const shake = (bass - 0.6) * (evolution * 2.0);
                camera.position.x = (Math.random()-0.5) * shake;
                camera.position.y = (Math.random()-0.5) * shake;
            }
        }
        
        // Camera roll
        camera.rotation.z = -distortion * 0.2;

        renderer.render(scene, camera);
        updateHUD();
    }

    function updateHUD() {
        document.getElementById('evoBar').style.width = (evolution * 100) + '%';
        document.getElementById('evoVal').innerText = Math.floor(evolution * 100) + '%';
        
        document.getElementById('distBar').style.width = (Math.abs(distortion) * 50) + '%';
        document.getElementById('distBar').style.marginLeft = distortion > 0 ? '50%' : (50 - Math.abs(distortion)*50) + '%';
        document.getElementById('distVal').innerText = Math.floor(distortion * 100) + '%';
    }

    // --- AUDIO ENGINE ---
    // Scale: D Minor (D, E, F, G, A, Bb, C)
    const SCALE = [73.42, 82.41, 87.31, 98.00, 110.00, 116.54, 130.81];

    function initAudio() {
        ac = new (window.AudioContext || window.webkitAudioContext)();
        master = ac.createGain();
        master.gain.value = 0.6; // High gain for impact

        filter = ac.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 100; // Start Closed
        filter.Q.value = 5; // Resonant

        limiter = ac.createDynamicsCompressor();
        limiter.threshold.value = -3;
        limiter.ratio.value = 20;

        // Reverb
        const len = ac.sampleRate * 2.0;
        const buf = ac.createBuffer(2, len, ac.sampleRate);
        for(let i=0; i<len; i++) {
            let d = (1 - i/len);
            buf.getChannelData(0)[i] = (Math.random()*2-1)*d;
            buf.getChannelData(1)[i] = (Math.random()*2-1)*d;
        }
        reverb = ac.createConvolver();
        reverb.buffer = buf;
        const revMix = ac.createGain();
        revMix.gain.value = 0.4;

        master.connect(filter);
        filter.connect(limiter);
        limiter.connect(ac.destination);
        filter.connect(reverb);
        reverb.connect(revMix);
        revMix.connect(limiter);

        analyser = ac.createAnalyser();
        analyser.fftSize = 64;
        limiter.connect(analyser);
    }

    // Instruments
    function playKick(t) {
        const osc = ac.createOscillator();
        const g = ac.createGain();
        osc.frequency.setValueAtTime(150, t);
        osc.frequency.exponentialRampToValueAtTime(40, t + 0.1);
        g.gain.setValueAtTime(1.2, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
        osc.connect(g); g.connect(master); // Bypass filter for punch
        osc.start(t); osc.stop(t+0.3);
    }

    function playBass(t, freq) {
        const osc = ac.createOscillator();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(freq, t);
        const f = ac.createBiquadFilter();
        f.type = 'lowpass';
        f.frequency.setValueAtTime(800, t); // Biting acid
        f.frequency.exponentialRampToValueAtTime(100, t + 0.2);
        f.Q.value = 8;
        const g = ac.createGain();
        g.gain.setValueAtTime(0.5, t);
        g.gain.linearRampToValueAtTime(0, t+0.2);
        osc.connect(f); f.connect(g); g.connect(master); // Bass also bypasses master filter for clarity
        osc.start(t); osc.stop(t+0.2);
    }

    function playLead(t, freq) {
        // SuperSaw Lead (Passes through Master Filter)
        const g = ac.createGain();
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.15, t+0.05);
        g.gain.exponentialRampToValueAtTime(0.001, t+0.2);
        
        [-10, 0, 10].forEach(d => {
            const o = ac.createOscillator();
            o.type = 'sawtooth';
            o.frequency.value = freq;
            o.detune.value = d;
            o.connect(g);
            o.start(t); o.stop(t+0.2);
        });
        g.connect(master); // Goes to filter
    }

    function playHat(t) {
        const b = ac.createBuffer(1, ac.sampleRate*0.05, ac.sampleRate);
        const d = b.getChannelData(0);
        for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
        const src = ac.createBufferSource();
        src.buffer = b;
        const f = ac.createBiquadFilter();
        f.type='highpass'; f.frequency.value=8000;
        const g = ac.createGain();
        g.gain.value = 0.2 * evolution; // Volume linked to evo
        src.connect(f); f.connect(g); g.connect(master);
        src.start(t);
    }

    // --- SEQUENCER ---
    function schedule() {
        const tempo = 140;
        const secPer16th = 60/tempo/4;
        const lookahead = 0.1;

        while(nextNoteTime < ac.currentTime + lookahead) {
            processStep(step, nextNoteTime);
            nextNoteTime += secPer16th;
            step = (step + 1) % 16;
        }
        if(isPlaying) setTimeout(schedule, 25);
    }

    function processStep(s, t) {
        // ALWAYS ON: KICK (4/4)
        if (s % 4 === 0) playKick(t);

        // EVO > 0.1: BASS (Offbeat)
        if (evolution > 0.1) {
            if (s % 4 === 2) playBass(t, SCALE[0]);
            // Double kick bass at higher evo
            if (evolution > 0.6 && s % 4 === 3) playBass(t, SCALE[0]);
        }

        // EVO > 0.3: LEAD/ARP
        if (evolution > 0.3) {
            // Arp pattern density increases with evo
            let play = false;
            if (s % 4 === 0) play = true;
            if (evolution > 0.5 && s % 2 === 0) play = true;
            if (evolution > 0.8) play = true; // 16ths
            
            if (play) {
                // Procedural melody notes
                const idx = (s + Math.floor(evolution * 10)) % SCALE.length;
                let freq = SCALE[idx] * 2; // Mid octave
                if (evolution > 0.9) freq *= 2; // High scream
                playLead(t, freq);
            }
        }

        // EVO > 0.4: HATS
        if (evolution > 0.4 && s % 2 === 0) playHat(t);
        if (evolution > 0.8 && s % 1 === 0) playHat(t);
    }

    // --- INIT ---
    document.getElementById('startBtn').addEventListener('click', () => {
        const ui = document.getElementById('ui');
        ui.style.opacity = 0;
        setTimeout(() => ui.style.display = 'none', 500);
        
        document.getElementById('hud').style.opacity = 1;
        document.getElementById('hintBox').style.opacity = 1;
        setTimeout(() => document.getElementById('hintBox').style.opacity = 0, 4000);

        init3D();
        initAudio();
        
        if(ac.state === 'suspended') ac.resume();
        isPlaying = true;
        nextNoteTime = ac.currentTime + 0.1;
        
        schedule();
        animate();
    });

</script>
</body>
</html>
